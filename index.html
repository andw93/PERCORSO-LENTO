<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timer con Rilevamento Movimento</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-analytics.js"></script>
    <style>
        #video {
            width: 100%;
            max-width: 600px;
        }
        #timer {
            font-size: 2em;
            margin-top: 20px;
        }
    </style>
</head>
<body>

<video id="video" autoplay></video>
<div id="timer">Tempo: 0s</div>
<button id="start">Inizia Timer</button>
<button id="stop">Ferma Timer</button>

<script>
    // Configurazione di Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyCzE1CfaqDBF2CpbCrhoIzhIMXrqDjhkQA",
        authDomain: "percorso-lento.firebaseapp.com",
        databaseURL: "https://percorso-lento-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "percorso-lento",
        storageBucket: "percorso-lento.appspot.com",
        messagingSenderId: "804922956072",
        appId: "1:804922956072:web:215133a98d820c16e3981d",
        measurementId: "G-25NWDBPJPD"
    };

    // Inizializza Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const analytics = firebase.getAnalytics(app);
    const database = firebase.database();

    let timerInterval;
    let seconds = 0;
    let timerRunning = false;

    // Accedi alla fotocamera
    navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
            document.getElementById('video').srcObject = stream;
            detectMotion(stream);
        })
        .catch(err => {
            console.error("Errore nell'accesso alla fotocamera: ", err);
        });

    // Funzione per il rilevamento del movimento
    function detectMotion(stream) {
        const video = document.getElementById('video');
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        let lastImageData;

        setInterval(() => {
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const currentImageData = context.getImageData(0, 0, canvas.width, canvas.height);

            if (lastImageData) {
                const diff = compareImages(lastImageData.data, currentImageData.data);
                if (diff > 10000) { // Soglia di movimento
                    if (!timerRunning) {
                        database.ref('timerStatus').set('start');
                    } else {
                        database.ref('timerStatus').set('stop');
                    }
                }
            }

            lastImageData = currentImageData;
        }, 100);
    }

    // Funzione per confrontare le immagini
    function compareImages(data1, data2) {
        let diff = 0;
        for (let i = 0; i < data1.length; i += 4) {
            const rDiff = Math.abs
            const rDiff = Math.abs(data1[i] - data2[i]);
            const gDiff = Math.abs(data1[i + 1] - data2[i + 1]);
            const bDiff = Math.abs(data1[i + 2] - data2[i + 2]);
            diff += rDiff + gDiff + bDiff;
        }
        return diff;
    }

    // Ascolta i cambiamenti nel database
    database.ref('timerStatus').on('value', (snapshot) => {
        const status = snapshot.val();
        if (status === 'start' && !timerRunning) {
            startTimer();
        } else if (status === 'stop' && timerRunning) {
            stopTimer();
        }
    });

    // Funzione per avviare il timer
    function startTimer() {
        timerRunning = true;
        timerInterval = setInterval(() => {
            seconds++;
            updateTimer();
        }, 1000);
    }

    // Funzione per fermare il timer
    function stopTimer() {
        clearInterval(timerInterval);
        timerRunning = false;
    }

    // Funzione per aggiornare il timer visualizzato
    function updateTimer() {
        document.getElementById('timer').innerText = `Tempo: ${seconds}s`;
    }

    // Event listeners per i pulsanti (opzionali, se vuoi controllare manualmente)
    document.getElementById('start').addEventListener('click', () => {
        database.ref('timerStatus').set('start');
    });

    document.getElementById('stop').addEventListener('click', () => {
        database.ref('timerStatus').set('stop');
    });
</script>

</body>
</html>
